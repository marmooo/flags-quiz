let totalCount=0,correctCount=0,answerPos=0;const problems=[],audioContext=new AudioContext,audioBufferCache={};loadAudio("correct","/flags-quiz/mp3/correct3.mp3"),loadAudio("incorrect","/flags-quiz/mp3/incorrect1.mp3"),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function changeLang(){const e=document.getElementById("lang"),t=e.options[e.selectedIndex].value;location.href=`/flags-quiz/${t}/`}async function playAudio(e,t){const s=await loadAudio(e,audioBufferCache[e]),n=audioContext.createBufferSource();if(n.buffer=s,t){const e=audioContext.createGain();e.gain.value=t,e.connect(audioContext.destination),n.connect(e),n.start()}else n.connect(audioContext.destination),n.start()}async function loadAudio(e,t){if(audioBufferCache[e])return audioBufferCache[e];const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}function unlockAudio(){audioContext.resume()}function getRandomInt(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e)+e)}function shuffle(e){for(let t=e.length;1<t;t--){const n=Math.floor(Math.random()*t);[e[n],e[t-1]]=[e[t-1],e[n]]}return e}function nextProblem(){const e=totalCount%problems.length;e==0&&shuffle(problems),answerPos=getRandomInt(0,4);const t=problems[e][0];document.getElementById("flag").textContent=t;const n=[...document.getElementById("choices").children];n.forEach((n,s)=>{if(s==answerPos)n.textContent=problems[e][2];else{let e;do e=getRandomInt(0,problems.length);while(problems[e][0]==t)n.textContent=problems[e][2]}}),gio.switchCountry(problems[e][1])}function scoring(){document.getElementById("score").textContent=correctCount,document.getElementById("total").textContent=totalCount}function loadProblems(){const e=document.documentElement.lang;fetch(`/flags-quiz/data/${e}.csv`).then(e=>e.text()).then(e=>{e.trim().split(`
`).forEach(e=>{const[t,n,s]=e.split(",");problems.push([t,n,s])}),shuffle(problems)})}function initProblems(){const e=[...document.getElementById("choices").children];e.forEach((t,n)=>{t.onclick=()=>{n==answerPos?(playAudio("correct"),e.forEach(e=>{e.classList.remove("text-danger")}),totalCount+=1,e.every(e=>!e.textContent.startsWith("❌"))&&(correctCount+=1),scoring(),nextProblem()):(playAudio("incorrect"),t.classList.add("text-danger"),t.textContent.startsWith("❌")||(t.textContent="❌ "+t.textContent))}})}function initGlobe(){const t=document.getElementById("globe"),n={control:{stats:!1,disableUnmentioned:!1,lightenMentioned:!0,inOnly:!1,outOnly:!1,initCountry:"JP",halo:!0,transparentBackground:!0,autoRotation:!1,rotationRatio:1},color:{surface:16777215,selected:2141154,in:16777215,out:2141154,halo:2141154,background:null},brightness:{ocean:1,mentioned:.5,related:.5}},e=new GIO.Controller(t,n);return e.onCountryPicked((t)=>{const s=totalCount==0?"JP":problems[totalCount][1],o=t.ISOCode;if(s!=o){const t=problems.find(e=>e[1]==o),n=document.getElementById("countryName");t?n.textContent=t[2]:n.textContent="The country is not registered.";const i=document.getElementById("countryInfo");i.addEventListener("hidden.bs.toast",()=>{e.switchCountry(s)});const a=bootstrap.Toast.getOrCreateInstance(i);a.show()}}),e.init(),e}if(navigator.userAgent.indexOf("Windows")!=-1){const e=new FontFace("flags","url(/flags-quiz/flags.woff2)");e.load().then(()=>{document.fonts.add(e),document.getElementById("flag").style.fontFamily="flags"})}initProblems(),loadProblems();const gio=initGlobe();document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("startButton").onclick=nextProblem,document.getElementById("lang").onchange=changeLang,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})
let totalCount=0,correctCount=0,answerPos=0;const problems=[],audioContext=new AudioContext,audioBufferCache={};loadAudio("correct","/flags-quiz/mp3/correct3.mp3"),loadAudio("incorrect","/flags-quiz/mp3/incorrect1.mp3"),loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function changeLang(){const a=document.getElementById("lang"),b=a.options[a.selectedIndex].value;location.href=`/flags-quiz/${b}/`}async function playAudio(b,c){const d=await loadAudio(b,audioBufferCache[b]),a=audioContext.createBufferSource();if(a.buffer=d,c){const b=audioContext.createGain();b.gain.value=c,b.connect(audioContext.destination),a.connect(b),a.start()}else a.connect(audioContext.destination),a.start()}async function loadAudio(a,c){if(audioBufferCache[a])return audioBufferCache[a];const d=await fetch(c),e=await d.arrayBuffer(),b=await audioContext.decodeAudioData(e);return audioBufferCache[a]=b,b}function unlockAudio(){audioContext.resume()}function getRandomInt(a,b){return a=Math.ceil(a),b=Math.floor(b),Math.floor(Math.random()*(b-a)+a)}function shuffle(a){for(let b=a.length;1<b;b--){const c=Math.floor(Math.random()*b);[a[c],a[b-1]]=[a[b-1],a[c]]}return a}function nextProblem(){const a=totalCount%problems.length;a==0&&shuffle(problems),answerPos=getRandomInt(0,4);const b=problems[a][0];document.getElementById("flag").textContent=b;const c=[...document.getElementById("choices").children];c.forEach((c,d)=>{if(d==answerPos)c.textContent=problems[a][2];else{let a;do a=getRandomInt(0,problems.length);while(problems[a][0]==b)c.textContent=problems[a][2]}}),gio.switchCountry(problems[a][1])}function scoring(){document.getElementById("score").textContent=correctCount,document.getElementById("total").textContent=totalCount}function loadProblems(){const a=document.documentElement.lang;fetch(`/flags-quiz/data/${a}.csv`).then(a=>a.text()).then(a=>{a.trim().split("\n").forEach(a=>{const[b,c,d]=a.split(",");problems.push([b,c,d])}),shuffle(problems)})}function initProblems(){const a=[...document.getElementById("choices").children];a.forEach((b,c)=>{b.onclick=()=>{c==answerPos?(playAudio("correct"),a.forEach(a=>{a.classList.remove("text-danger")}),totalCount+=1,a.every(a=>!a.textContent.startsWith("×"))&&(correctCount+=1),scoring(),nextProblem()):(playAudio("incorrect"),b.classList.add("text-danger"),b.textContent="×"+b.textContent)}})}function initGlobe(){const b=document.getElementById("globe"),c={control:{stats:!1,disableUnmentioned:!1,lightenMentioned:!0,inOnly:!1,outOnly:!1,initCountry:"JP",halo:!0,transparentBackground:!0,autoRotation:!1,rotationRatio:1},color:{surface:16777215,selected:2141154,in:16777215,out:2141154,halo:2141154,background:null},brightness:{ocean:1,mentioned:.5,related:.5}},a=new GIO.Controller(b,c);return a.onCountryPicked((d,e)=>{const b=totalCount==0?"JP":problems[totalCount][1],c=d.ISOCode;if(b!=c){const d=problems.find(a=>a[1]==c),e=document.getElementById("countryName");d?e.textContent=d[2]:e.textContent="The country is not registered.";const f=document.getElementById("countryInfo");f.addEventListener("hidden.bs.toast",()=>{a.switchCountry(b)});const g=bootstrap.Toast.getOrCreateInstance(f);g.show()}}),a.init(),a}if(navigator.userAgent.indexOf("Windows")!=-1){const a=new FontFace("flags","url(/flags-quiz/flags.woff2)");a.load().then(()=>{document.fonts.add(a),document.getElementById("flag").style.fontFamily="flags"})}initProblems(),loadProblems();const gio=initGlobe();document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("startButton").onclick=nextProblem,document.getElementById("lang").onchange=changeLang,document.addEventListener("click",unlockAudio,{once:!0,useCapture:!0})